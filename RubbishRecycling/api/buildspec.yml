version: 0.1

phases:
  pre_build:
    commands:
      - echo -n "$CODEBUILD_BUILD_ID" | sed "s/.*:\([[:xdigit:]]\{7\}\).*/\1/" > /tmp/build_id.out
      - printf '{"tag":"%s"}' "$(cat /tmp/build_id.out)" > /tmp/build.json
      - echo Logging in to Amazon ECR
      - $(aws ecr get-login --region $AWS_DEFAULT_REGION)

      - echo install node
      - curl -sL https://deb.nodesource.com/setup_6.x | bash
      - apt-get -y install nodejs
      - npm install npm -g
  build:
    commands:
      - echo build front-end
      - npm install
      - npm run wb
      - npm run build
      - |-
        curl -H "Content-Type: application/json" -X \
        POST -d @config.json \
        https://lle3j3c6r9.execute-api.ap-southeast-2.amazonaws.com/Prod/ecs?pretty > /tmp/ecs-service.json
      - echo Build started on `date` for $ASPNETCORE_ENVIRONMENT
      - docker build --tag "$REPOSITORY_URI:$(cat /tmp/build_id.out)" .
  post_build:
    commands:
      - echo Build completed on `date`
      - echo Pushing the Docker image...
      - docker push "$REPOSITORY_URI:$(cat /tmp/build_id.out)"
artifacts:
  files:
    - /tmp/build.json
    - /tmp/ecs-service.json

  discard-paths: yes